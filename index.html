<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador de Código QR</title>
    <!-- Tailwind CSS CDN para estilos responsivos y modernos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librería para convertir elementos HTML en imágenes -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- Usar <link> para la fuente en lugar de @import en <style> -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Estilos para el mensaje emergente */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1.5rem 2rem;
            border-radius: 0.75rem;
            color: white;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 100;
            display: none;
            transition: all 0.5s ease-in-out;
            max-width: 90%;
            width: fit-content;
        }
        .message-box.authorized {
            background-color: #10b981; /* Verde esmeralda */
        }
        .message-box.unauthorized {
            background-color: #ef4444; /* Rojo */
        }

        /* Clases de colores de fondo dinámicos */
        .bg-authorized {
            background-color: #d1fae5; /* Verde claro */
        }
        .bg-unauthorized {
            background-color: #fee2e2; /* Rojo claro */
        }
        .text-authorized {
            color: #065f46; /* Verde oscuro */
        }
        .text-unauthorized {
            color: #991b1b; /* Rojo oscuro */
        }

        /* Estilos específicos para la impresión */
        @media print {
            body {
                background-color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print {
                display: none !important;
            }
            #qr-list {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 1.5rem;
            }
            /* Ajustar el tamaño de la tarjeta para impresión con la proporción áurea */
            .printable-card {
                width: 320px;
                height: 518px; /* Proporción áurea (320 * 1.618) */
                box-shadow: none;
                border: 1px solid #ccc;
                padding: 1rem;
                page-break-inside: avoid;
                margin-bottom: 1.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <!-- Contenedor principal de la aplicación -->
    <div id="main-container" class="max-w-4xl w-full bg-white rounded-xl shadow-2xl p-6 md:p-10 space-y-8 transition-colors duration-500">

        <!-- Título de la aplicación -->
        <h1 class="text-4xl md:text-5xl font-bold text-center text-gray-800 no-print">
            Validador de Acceso
        </h1>

        <!-- Pestañas de navegación -->
        <div id="tab-navigation" class="flex justify-center border-b border-gray-200 no-print">
            <button id="tab-generator" class="py-3 px-6 text-lg font-medium text-gray-600 hover:text-indigo-600 border-b-2 border-transparent hover:border-indigo-500 focus:outline-none transition-colors duration-200">
                Generador de Códigos
            </button>
            <button id="tab-scanner" class="py-3 px-6 text-lg font-medium text-gray-600 hover:text-indigo-600 border-b-2 border-transparent hover:border-indigo-500 focus:outline-none transition-colors duration-200">
                Escáner de QR
            </button>
        </div>

        <!-- Sección de generación de códigos QR -->
        <div id="qr-generator-section" class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700 text-center no-print">Tarjetas de Acceso Autorizado</h2>
            <!-- Botones de impresión y guardar como imagen -->
            <div class="flex justify-center gap-4 no-print">
                <button id="print-button" class="bg-indigo-600 text-white px-6 py-3 rounded-md font-semibold text-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                    Imprimir Tarjetas
                </button>
                <button id="save-button" class="bg-green-600 text-white px-6 py-3 rounded-md font-semibold text-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                    Guardar como Imagen
                </button>
            </div>
            
            <div id="qr-list" class="flex flex-col items-center gap-6">
                <!-- Los códigos QR se renderizarán aquí -->
            </div>
        </div>

        <!-- Sección del escáner de QR -->
        <div id="qr-scanner-section" class="hidden flex flex-col items-center space-y-6 no-print">
            <h2 class="text-2xl font-semibold text-gray-700 text-center">Escanear para Validar</h2>
            <button id="start-scanner-button" class="bg-indigo-600 text-white px-6 py-3 rounded-md font-semibold text-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                Habilitar Cámara
            </button>
            <div id="reader" class="w-full max-w-sm rounded-lg overflow-hidden border-4 border-indigo-500 shadow-xl mt-4 hidden"></div>
            <p id="scanner-instruction" class="text-lg text-gray-500 text-center mt-4">
                Presiona "Habilitar Cámara" para comenzar a escanear.
            </p>
        </div>

        <!-- SECCIÓN: Página de validación de acceso -->
        <div id="result-page-section" class="hidden flex flex-col items-center space-y-6 text-center">
            <!-- Espacio para la foto del usuario -->
            <img id="result-photo" class="w-32 h-32 rounded-lg ring-4 ring-gray-300 object-cover mb-4 hidden" src="" alt="Foto del usuario">
            <h2 id="result-title" class="text-4xl font-bold"></h2>
            <p id="result-user-info" class="text-2xl font-semibold"></p>
            <div id="result-dates" class="text-lg text-gray-600"></div>
            <div id="result-badge" class="font-bold py-3 px-6 rounded-full shadow-lg">
                <span id="result-text" class="text-xl"></span>
            </div>
            <button id="back-to-scanner-button" class="bg-gray-500 text-white px-6 py-3 rounded-md font-semibold text-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors duration-200 mt-8">
                Volver a Escanear
            </button>
        </div>
    </div>

    <!-- Scripts CDN para las librerías -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script>
        // Variable para almacenar la lista de usuarios. Inicialmente vacía.
        let authorizedUsers = [];

        // Elementos del DOM
        const mainContainer = document.getElementById('main-container');
        const qrList = document.getElementById('qr-list');
        const qrGeneratorSection = document.getElementById('qr-generator-section');
        const qrScannerSection = document.getElementById('qr-scanner-section');
        const resultPageSection = document.getElementById('result-page-section');
        const resultPhoto = document.getElementById('result-photo');
        const resultTitle = document.getElementById('result-title');
        const resultUserInfo = document.getElementById('result-user-info');
        const resultDates = document.getElementById('result-dates');
        const resultBadge = document.getElementById('result-badge');
        const resultText = document.getElementById('result-text');
        const backToScannerButton = document.getElementById('back-to-scanner-button');
        const tabGenerator = document.getElementById('tab-generator');
        const tabScanner = document.getElementById('tab-scanner');
        const tabNavigation = document.getElementById('tab-navigation');
        const startScannerButton = document.getElementById('start-scanner-button');
        const scannerInstruction = document.getElementById('scanner-instruction');
        const readerDiv = document.getElementById('reader');
        const printButton = document.getElementById('print-button');
        const saveButton = document.getElementById('save-button');

        // Variable para rastrear el estado del escáner
        let isScannerRunning = false;

        // Configuración del escáner de QR
        const html5QrCode = new Html5Qrcode("reader");
        const qrCodeScannerConfig = { fps: 10, qrbox: { width: 250, height: 250 } };

        // Función para cargar los datos del archivo JSON
        async function loadUserData() {
            try {
                const now = new Date().getTime();
                const url = `users.json?v=${now}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                authorizedUsers = await response.json();
                console.log("Datos de usuarios cargados:", authorizedUsers);
                generateQRCodes();
            } catch (error) {
                console.error("Error al cargar los datos de los usuarios:", error);
                qrGeneratorSection.innerHTML = '<p class="text-center text-red-500 font-semibold text-lg p-4">Error al cargar los datos del personal. Asegúrate de que el archivo `users.json` exista y sea válido en tu repositorio de GitHub.</p>';
            }
        }

        // Función para mostrar la página de resultados
        function showResultPage(userName, isAuthorized, message = null, photoUrl = null) {
            qrScannerSection.classList.add('hidden');
            tabNavigation.classList.add('hidden');
            resultPageSection.classList.remove('hidden');

            mainContainer.classList.remove('bg-white', 'bg-authorized', 'bg-unauthorized');
            resultTitle.classList.remove('text-authorized', 'text-unauthorized');
            resultUserInfo.classList.remove('text-authorized', 'text-unauthorized');
            resultBadge.classList.remove('bg-green-500', 'bg-red-500');

            if (photoUrl) {
                resultPhoto.src = photoUrl;
                resultPhoto.classList.remove('hidden');
            } else {
                resultPhoto.classList.add('hidden');
            }

            if (isAuthorized) {
                mainContainer.classList.add('bg-authorized');
                resultTitle.classList.add('text-authorized');
                resultUserInfo.classList.add('text-authorized');
                resultBadge.classList.add('bg-green-500', 'text-white');
                resultTitle.textContent = "Acceso Autorizado";
                resultUserInfo.textContent = userName;
                resultDates.textContent = message;
                resultText.textContent = "Autorizado";
            } else {
                mainContainer.classList.add('bg-unauthorized');
                resultTitle.classList.add('text-unauthorized');
                resultUserInfo.classList.add('text-unauthorized');
                resultBadge.classList.add('bg-red-500', 'text-white');
                resultTitle.textContent = "Acceso Denegado";
                resultUserInfo.textContent = userName;
                resultDates.textContent = message;
                resultText.textContent = "No Autorizado";
            }
        }

        // Función para generar y mostrar los códigos QR con el diseño mejorado
        function generateQRCodes() {
            qrList.innerHTML = '';
            authorizedUsers.forEach(user => {
                const card = document.createElement('div');
                // Se usa un layout de columna simple con espaciado para evitar que el QR se salga del borde.
                card.className = 'w-[320px] h-[518px] bg-gray-50 p-6 rounded-xl shadow-lg flex flex-col items-center space-y-4 printable-card';
                card.id = `card-${user.name.replace(/\s/g, '-')}`;

                // Imagen de perfil cuadrada
                const userPhoto = document.createElement('img');
                userPhoto.className = 'w-48 h-48 rounded-lg object-cover ring-2 ring-gray-300';
                userPhoto.src = user.photoUrl; 
                userPhoto.alt = `Foto de perfil de ${user.name}`;
                userPhoto.onerror = () => { userPhoto.src = `https://placehold.co/192x192/CCCCCC/000000?text=${user.name.split(' ').map(n => n[0]).join('')}`; };
                card.appendChild(userPhoto);

                // Nombre del usuario
                const name = document.createElement('p');
                name.className = 'text-2xl font-bold text-gray-700 text-center';
                name.textContent = user.name;
                card.appendChild(name);
                
                // Título de la tarjeta (ID de Acceso)
                const cardTitle = document.createElement('p');
                cardTitle.className = 'text-sm font-semibold text-gray-400';
                cardTitle.textContent = 'ID de Acceso';
                card.appendChild(cardTitle);

                // Canvas para el código QR
                const qrCanvas = document.createElement('canvas');
                qrCanvas.id = `qr-canvas-${user.name.replace(/\s/g, '-')}`;
                qrCanvas.className = 'w-32 h-32';
                card.appendChild(qrCanvas);
                
                QRCode.toCanvas(qrCanvas, user.name, { errorCorrectionLevel: 'H', scale: 8 }, function (error) {
                    if (error) console.error(error);
                });

                qrList.appendChild(card);
            });
        }

        // Callback cuando se escanea un código QR con éxito
        const onScanSuccess = (decodedText, decodedResult) => {
            console.log(`Código escaneado: ${decodedText}`);
            html5QrCode.stop().then(() => {
                isScannerRunning = false;
            }).catch(err => {});

            const user = authorizedUsers.find(u => u.name === decodedText);

            if (user) {
                const today = new Date();
                const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const fromDate = new Date(user.authorizedFrom);
                const untilDate = new Date(user.authorizedUntil);

                console.log("Fecha actual (medianoche):", todayMidnight);
                console.log("Fecha de inicio:", fromDate);
                console.log("Fecha de fin:", untilDate);

                if (todayMidnight >= fromDate && todayMidnight <= untilDate) {
                    const datesMessage = `Válido desde ${user.authorizedFrom} hasta ${user.authorizedUntil}.`;
                    showResultPage(user.name, true, datesMessage, user.photoUrl);
                } else {
                    showResultPage(user.name, false, "El acceso no está autorizado en esta fecha.", user.photoUrl);
                }

            } else {
                showResultPage(decodedText, false, "Usuario no autorizado.", null);
            }
        };

        // Función para iniciar el escáner
        function startScanner() {
            startScannerButton.textContent = "Iniciando...";
            startScannerButton.disabled = true;
            readerDiv.classList.remove('hidden');
            scannerInstruction.textContent = "Apunta la cámara a un código QR para validar el acceso.";

            html5QrCode.start({ facingMode: "environment" }, qrCodeScannerConfig, onScanSuccess)
                .then(() => {
                    isScannerRunning = true;
                    startScannerButton.classList.add('hidden');
                })
                .catch(err => {
                    console.error("Error al iniciar el escáner: ", err);
                    startScannerButton.textContent = "Reintentar Habilitar Cámara";
                    startScannerButton.disabled = false;
                    readerDiv.classList.add('hidden');
                    scannerInstruction.textContent = "Acceso a la cámara denegado. Por favor, revisa la configuración de tu navegador.";
                });
        }
        
        // Función para cambiar de pestaña y manejar el escáner
        function changeTab(targetTab) {
            qrGeneratorSection.classList.add('hidden');
            qrScannerSection.classList.add('hidden');
            resultPageSection.classList.add('hidden');

            mainContainer.classList.remove('bg-authorized', 'bg-unauthorized');
            mainContainer.classList.add('bg-white');
            tabNavigation.classList.remove('hidden');
            
            if (isScannerRunning) {
                html5QrCode.stop().then(() => {
                    isScannerRunning = false;
                }).catch(err => {});
            }

            tabGenerator.classList.remove('border-indigo-500', 'text-indigo-600');
            tabScanner.classList.remove('border-indigo-500', 'text-indigo-600');

            if (targetTab === 'generator') {
                qrGeneratorSection.classList.remove('hidden');
                tabGenerator.classList.add('border-indigo-500', 'text-indigo-600');
                generateQRCodes();
            } else if (targetTab === 'scanner') {
                qrScannerSection.classList.remove('hidden');
                tabScanner.classList.add('border-indigo-500', 'text-indigo-600');
                
                startScannerButton.classList.remove('hidden');
                startScannerButton.textContent = "Habilitar Cámara";
                startScannerButton.disabled = false;
                readerDiv.classList.add('hidden');
                scannerInstruction.textContent = "Presiona 'Habilitar Cámara' para comenzar a escanear.";
            }
        }

        // Función para imprimir las tarjetas
        function printCards() {
            window.print();
        }

        // Función para guardar las tarjetas COMPLETAS como imágenes
        async function saveCardsAsImages() {
            const cards = document.querySelectorAll('.printable-card');
            
            for (const card of cards) {
                const canvas = await html2canvas(card, {
                    scale: 2,
                    logging: false
                });

                const dataURL = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataURL;
                const userName = card.id.replace('card-', '');
                link.download = `${userName}-credencial.png`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Manejadores de eventos para los botones
        tabGenerator.addEventListener('click', () => changeTab('generator'));
        tabScanner.addEventListener('click', () => changeTab('scanner'));
        startScannerButton.addEventListener('click', startScanner);
        backToScannerButton.addEventListener('click', () => changeTab('scanner'));
        printButton.addEventListener('click', printCards);
        saveButton.addEventListener('click', saveCardsAsImages);

        // Iniciar la aplicación y cargar los datos
        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
            changeTab('generator');
        });
    </script>
</body>
</html>
