<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador de Código QR</title>
    <!-- Tailwind CSS CDN para estilos responsivos y modernos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librería para convertir elementos HTML en imágenes -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Estilos para el mensaje emergente, si es necesario */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1.5rem 2rem;
            border-radius: 0.75rem;
            color: white;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 100;
            display: none;
            transition: all 0.5s ease-in-out;
            max-width: 90%;
            width: fit-content;
        }
        .message-box.authorized {
            background-color: #10b981; /* Verde esmeralda */
        }
        .message-box.unauthorized {
            background-color: #ef4444; /* Rojo */
        }
        .message-box.info {
            background-color: #3b82f6; /* Azul */
        }

        /* Clases de colores de fondo dinámicos */
        .bg-authorized {
            background-color: #d1fae5; /* Verde claro */
        }
        .bg-unauthorized {
            background-color: #fee2e2; /* Rojo claro */
        }
        .text-authorized {
            color: #065f46; /* Verde oscuro */
        }
        .text-unauthorized {
            color: #991b1b; /* Rojo oscuro */
        }

        /* Estilos específicos para la impresión */
        @media print {
            body {
                background-color: white !important; /* Fondo blanco para ahorrar tinta */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            /* Ocultar elementos no necesarios para la impresión */
            .no-print {
                display: none !important;
            }
            /* Mostrar las tarjetas en una grilla para optimizar el espacio en la hoja */
            #qr-list {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                padding: 1.5rem;
                gap: 1.5rem;
            }
            /* Ajustar el tamaño de la tarjeta para impresión, quitando la sombra y el padding extra */
            .printable-card {
                width: 320px;
                box-shadow: none;
                border: 1px solid #ccc;
                padding: 1rem;
                page-break-inside: avoid;
                margin-bottom: 1.5rem;
            }
            .printable-card canvas {
                width: 128px;
                height: 128px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <!-- Contenedor principal de la aplicación -->
    <div id="main-container" class="max-w-4xl w-full bg-white rounded-xl shadow-2xl p-6 md:p-10 space-y-8 transition-colors duration-500">

        <!-- Título de la aplicación -->
        <h1 class="text-4xl md:text-5xl font-bold text-center text-gray-800 no-print">
            Validador de Acceso
        </h1>

        <!-- Pestañas de navegación -->
        <div id="tab-navigation" class="flex justify-center border-b border-gray-200 no-print">
            <button id="tab-generator" class="py-3 px-6 text-lg font-medium text-gray-600 hover:text-indigo-600 border-b-2 border-transparent hover:border-indigo-500 focus:outline-none transition-colors duration-200">
                Generador de Códigos
            </button>
            <button id="tab-scanner" class="py-3 px-6 text-lg font-medium text-gray-600 hover:text-indigo-600 border-b-2 border-transparent hover:border-indigo-500 focus:outline-none transition-colors duration-200">
                Escáner de QR
            </button>
            <button id="tab-history" class="py-3 px-6 text-lg font-medium text-gray-600 hover:text-indigo-600 border-b-2 border-transparent hover:border-indigo-500 focus:outline-none transition-colors duration-200">
                Historial de Escaneos
            </button>
            <button id="tab-admin" class="py-3 px-6 text-lg font-medium text-gray-600 hover:text-indigo-600 border-b-2 border-transparent hover:border-indigo-500 focus:outline-none transition-colors duration-200 hidden">
                Administrador
            </button>
        </div>

        <!-- Sección de generación de códigos QR -->
        <div id="qr-generator-section" class="hidden space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700 text-center no-print">Tarjetas de Acceso Autorizado</h2>
            <!-- Botones de impresión y guardar como imagen -->
            <div class="flex justify-center gap-4 no-print">
                <button id="print-button" class="bg-indigo-600 text-white px-6 py-3 rounded-md font-semibold text-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                    Imprimir Tarjetas
                </button>
                <button id="save-button" class="bg-green-600 text-white px-6 py-3 rounded-md font-semibold text-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                    Guardar como Imagen
                </button>
            </div>
            
            <div id="qr-list" class="flex flex-col items-center gap-6">
                <!-- Los códigos QR se renderizarán aquí -->
            </div>
        </div>

        <!-- Sección del escáner de QR -->
        <div id="qr-scanner-section" class="flex flex-col items-center space-y-6 no-print">
            <h2 class="text-2xl font-semibold text-gray-700 text-center">Escanear para Validar</h2>
            
            <!-- Botones de selección de Ingreso/Salida -->
            <div class="flex space-x-4">
                <button id="mode-ingreso" class="px-6 py-3 rounded-md text-lg font-semibold bg-indigo-500 text-white shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    Ingreso
                </button>
                <button id="mode-salida" class="px-6 py-3 rounded-md text-lg font-semibold bg-gray-300 text-gray-800 shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    Salida
                </button>
            </div>
            
            <button id="start-scanner-button" class="bg-indigo-600 text-white px-6 py-3 rounded-md font-semibold text-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                Habilitar Cámara
            </button>
            <div id="reader" class="w-full max-w-sm rounded-lg overflow-hidden border-4 border-indigo-500 shadow-xl mt-4 hidden"></div>
            <p id="scanner-instruction" class="text-lg text-gray-500 text-center mt-4">
                Presiona "Habilitar Cámara" para comenzar a escanear.
            </p>
        </div>

        <!-- SECCIÓN: Página de validación de acceso -->
        <div id="result-page-section" class="hidden flex flex-col items-center space-y-6 text-center">
            <!-- Espacio para la foto del usuario -->
            <img id="result-photo" class="w-32 h-32 rounded-lg ring-4 ring-gray-300 object-cover mb-4 hidden" src="" alt="Foto del usuario">
            <h2 id="result-title" class="text-4xl font-bold"></h2>
            <p id="result-user-info" class="text-2xl font-semibold"></p>
            <div id="result-dates" class="text-lg text-gray-600"></div> <!-- NUEVO ELEMENTO PARA LAS FECHAS -->
            <div id="result-badge" class="font-bold py-3 px-6 rounded-full shadow-lg">
                <span id="result-text" class="text-xl"></span>
            </div>
            <button id="back-to-scanner-button" class="bg-gray-500 text-white px-6 py-3 rounded-md font-semibold text-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors duration-200 mt-8">
                Volver a Escanear
            </button>
        </div>

        <!-- SECCIÓN: Historial de escaneos -->
        <div id="history-section" class="hidden space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700 text-center">Historial de Escaneos</h2>
            <div id="history-container" class="overflow-x-auto relative shadow-md sm:rounded-lg">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="py-3 px-6">
                                Usuario
                            </th>
                            <th scope="col" class="py-3 px-6">
                                Tipo
                            </th>
                            <th scope="col" class="py-3 px-6">
                                Fecha y Hora
                            </th>
                        </tr>
                    </thead>
                    <tbody id="history-list">
                        <!-- Las filas de datos se renderizarán aquí -->
                    </tbody>
                </table>
            </div>
            <p id="history-message" class="text-center text-gray-500 hidden">
                Cargando historial...
            </p>
        </div>

        <!-- SECCIÓN: Administrador de Usuarios -->
        <div id="admin-section" class="hidden space-y-8">
            <h2 class="text-2xl font-semibold text-gray-700 text-center">Administrador de Usuarios</h2>
            
            <!-- Formulario para agregar/editar usuarios -->
            <div class="bg-gray-50 p-6 rounded-xl shadow-md">
                <h3 id="form-title" class="text-xl font-semibold text-gray-700 mb-4">Agregar Nuevo Usuario</h3>
                <form id="user-form" class="space-y-4">
                    <div>
                        <label for="userNameInput" class="block text-sm font-medium text-gray-700">Nombre del Usuario</label>
                        <input type="text" id="userNameInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                    </div>
                    <div>
                        <label for="photoUrlInput" class="block text-sm font-medium text-gray-700">URL de la Foto (Opcional)</label>
                        <input type="text" id="photoUrlInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="authorizedFromInput" class="block text-sm font-medium text-gray-700">Válido desde</label>
                            <input type="date" id="authorizedFromInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                        </div>
                        <div>
                            <label for="authorizedUntilInput" class="block text-sm font-medium text-gray-700">Válido hasta</label>
                            <input type="date" id="authorizedUntilInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" id="saveUserBtn" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            Guardar Usuario
                        </button>
                        <button type="button" id="cancelEditBtn" class="w-full bg-gray-300 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 hidden">
                            Cancelar Edición
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Tabla de usuarios existentes -->
            <div class="overflow-x-auto relative shadow-md sm:rounded-lg">
                <p id="users-loading-message" class="text-center text-gray-500 py-4 hidden">Cargando usuarios...</p>
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="py-3 px-6">Nombre</th>
                            <th scope="col" class="py-3 px-6">Foto</th>
                            <th scope="col" class="py-3 px-6">Válido Desde</th>
                            <th scope="col" class="py-3 px-6">Válido Hasta</th>
                            <th scope="col" class="py-3 px-6">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="user-list-body">
                        <!-- Las filas de usuarios se renderizarán aquí -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Mensaje emergente para mostrar el resultado de la validación -->
    <div id="message-box" class="message-box"></div>

    <!-- Scripts CDN para las librerías -->
    <!-- Librería para generar códigos QR -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <!-- Librería para escanear códigos QR con la cámara -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales para Firebase
        let db;
        let auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Función para inicializar Firebase y autenticar
        async function initFirebase() {
            try {
                // Obtener las variables globales proporcionadas por el entorno
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config no encontrada. Asegúrate de que las variables __firebase_config y __app_id estén disponibles.");
                    return;
                }

                // Inicializar la app de Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Iniciar sesión de forma anónima para permitir el acceso a la base de datos
                await signInAnonymously(auth);
                console.log("Autenticación anónima exitosa.");

                // Iniciar el listener de usuarios
                setupUserListener();
                
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
            }
        }
        
        // Variable para almacenar la lista de usuarios.
        let authorizedUsers = [];
        
        // Estado para el modo de escaneo (ingreso/salida)
        let scanMode = 'ingreso';
        let editingDocId = null; // ID del documento que se está editando

        // Elementos del DOM
        const mainContainer = document.getElementById('main-container');
        const qrList = document.getElementById('qr-list');
        const qrGeneratorSection = document.getElementById('qr-generator-section');
        const qrScannerSection = document.getElementById('qr-scanner-section');
        const resultPageSection = document.getElementById('result-page-section');
        const historySection = document.getElementById('history-section');
        const adminSection = document.getElementById('admin-section');
        const userForm = document.getElementById('user-form');
        const userNameInput = document.getElementById('userNameInput');
        const photoUrlInput = document.getElementById('photoUrlInput');
        const authorizedFromInput = document.getElementById('authorizedFromInput');
        const authorizedUntilInput = document.getElementById('authorizedUntilInput');
        const saveUserBtn = document.getElementById('saveUserBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const formTitle = document.getElementById('form-title');
        const userListBody = document.getElementById('user-list-body');
        const usersLoadingMessage = document.getElementById('users-loading-message');

        const historyList = document.getElementById('history-list');
        const historyMessage = document.getElementById('history-message');

        const resultPhoto = document.getElementById('result-photo');
        const resultTitle = document.getElementById('result-title');
        const resultUserInfo = document.getElementById('result-user-info');
        const resultDates = document.getElementById('result-dates');
        const resultBadge = document.getElementById('result-badge');
        const resultText = document.getElementById('result-text');
        const backToScannerButton = document.getElementById('back-to-scanner-button');
        const tabGenerator = document.getElementById('tab-generator');
        const tabScanner = document.getElementById('tab-scanner');
        const tabHistory = document.getElementById('tab-history');
        const tabAdmin = document.getElementById('tab-admin');
        const tabNavigation = document.getElementById('tab-navigation');
        const startScannerButton = document.getElementById('start-scanner-button');
        const scannerInstruction = document.getElementById('scanner-instruction');
        const readerDiv = document.getElementById('reader');
        const printButton = document.getElementById('print-button');
        const saveButton = document.getElementById('save-button');
        const messageBox = document.getElementById('message-box');
        const modeIngresoBtn = document.getElementById('mode-ingreso');
        const modeSalidaBtn = document.getElementById('mode-salida');

        // Variable para rastrear el estado del escáner
        let isScannerRunning = false;

        // Configuración del escáner de QR
        const html5QrCode = new Html5Qrcode("reader");
        const qrCodeScannerConfig = { fps: 10, qrbox: { width: 250, height: 250 } };

        // Función para mostrar mensajes emergentes
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('authorized', 'unauthorized', 'info');
            messageBox.classList.add(type);
            messageBox.style.display = 'block';

            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        // Función para escuchar cambios en la colección de usuarios
        function setupUserListener() {
            if (!db) return;
            const usersCol = collection(db, 'artifacts', appId, 'public', 'data', 'users');
            usersLoadingMessage.classList.remove('hidden');

            onSnapshot(usersCol, (querySnapshot) => {
                authorizedUsers = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    authorizedUsers.push({ id: doc.id, ...data });
                });
                console.log("Datos de usuarios actualizados:", authorizedUsers);
                
                // Re-renderizar la lista de usuarios en el admin panel
                renderUserList();
                // Ocultar el mensaje de carga
                usersLoadingMessage.classList.add('hidden');

                // Si la pestaña actual es la del generador, se vuelven a generar los QR.
                if (!qrGeneratorSection.classList.contains('hidden')) {
                    generateQRCodes();
                }
            }, (error) => {
                console.error("Error al escuchar cambios en la colección de usuarios:", error);
                usersLoadingMessage.textContent = "Error al cargar los usuarios. Inténtalo de nuevo.";
            });
        }

        // Función para renderizar la tabla de usuarios en el admin panel
        function renderUserList() {
            userListBody.innerHTML = '';
            if (authorizedUsers.length === 0) {
                userListBody.innerHTML = `
                    <tr class="bg-white border-b">
                        <td colspan="5" class="text-center py-4 text-gray-400">No hay usuarios registrados.</td>
                    </tr>
                `;
                return;
            }

            authorizedUsers.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                
                const fromDate = user.authorizedFrom instanceof Date ? user.authorizedFrom.toISOString().split('T')[0] : user.authorizedFrom;
                const untilDate = user.authorizedUntil instanceof Date ? user.authorizedUntil.toISOString().split('T')[0] : user.authorizedUntil;

                row.innerHTML = `
                    <td class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap">${user.name}</td>
                    <td class="py-4 px-6">
                        <img src="${user.photoUrl || 'https://placehold.co/40x40/CCCCCC/000000?text=User'}" 
                             onerror="this.src='https://placehold.co/40x40/CCCCCC/000000?text=User'" 
                             alt="Foto de ${user.name}" class="w-10 h-10 rounded-full object-cover">
                    </td>
                    <td class="py-4 px-6">${fromDate}</td>
                    <td class="py-4 px-6">${untilDate}</td>
                    <td class="py-4 px-6 flex space-x-2">
                        <button class="edit-btn bg-yellow-500 text-white p-2 rounded-full hover:bg-yellow-600 transition-colors" data-id="${user.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.657 5.657l-1.414 1.414 4.242 4.242 1.414-1.414-4.242-4.242z" />
                                <path fill-rule="evenodd" d="M2 13.586V16a1 1 0 001 1h2.414l-4.707 4.707a1 1 0 01-1.414-1.414L3.586 16H2z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button class="delete-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors" data-id="${user.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm3.707 3.707a1 1 0 01-1.414 0L10 6.586l-2.293-2.293a1 1 0 011.414-1.414L10 5.172l2.293-2.293a1 1 0 011.414 1.414L11.414 7l2.293 2.293a1 1 0 01-1.414 1.414L10 8.414l-2.293 2.293a1 1 0 01-1.414-1.414L8.414 7l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                `;
                userListBody.appendChild(row);
            });

            // Añadir event listeners a los botones de la tabla
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', handleEditUser);
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDeleteUser);
            });
        }

        // Manejador para el envío del formulario (agregar/editar)
        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = userNameInput.value.trim();
            const photoUrl = photoUrlInput.value.trim();
            const authorizedFrom = authorizedFromInput.value;
            const authorizedUntil = authorizedUntilInput.value;

            if (!name || !authorizedFrom || !authorizedUntil) {
                showMessage("Por favor, completa todos los campos obligatorios.", "unauthorized");
                return;
            }

            const newUser = {
                name: name,
                photoUrl: photoUrl,
                authorizedFrom: authorizedFrom,
                authorizedUntil: authorizedUntil
            };

            try {
                if (editingDocId) {
                    // Actualizar usuario existente
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', editingDocId);
                    await updateDoc(userRef, newUser);
                    showMessage("Usuario actualizado con éxito.", "authorized");
                } else {
                    // Agregar nuevo usuario
                    const usersCol = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                    await addDoc(usersCol, newUser);
                    showMessage("Usuario agregado con éxito.", "authorized");
                }
                
                // Limpiar el formulario
                userForm.reset();
                resetFormState();

            } catch (e) {
                console.error("Error al guardar el usuario:", e);
                showMessage("Error al guardar el usuario.", "unauthorized");
            }
        });

        // Manejador para el botón de editar
        function handleEditUser(e) {
            const userId = e.currentTarget.dataset.id;
            const userToEdit = authorizedUsers.find(user => user.id === userId);

            if (userToEdit) {
                // Rellenar el formulario con los datos del usuario
                userNameInput.value = userToEdit.name;
                photoUrlInput.value = userToEdit.photoUrl || '';
                authorizedFromInput.value = userToEdit.authorizedFrom;
                authorizedUntilInput.value = userToEdit.authorizedUntil;

                // Cambiar el estado del formulario a "editar"
                editingDocId = userId;
                formTitle.textContent = "Editar Usuario";
                saveUserBtn.textContent = "Actualizar Usuario";
                cancelEditBtn.classList.remove('hidden');
                showMessage(`Editando a ${userToEdit.name}.`, 'info');
            }
        }

        // Manejador para el botón de cancelar edición
        cancelEditBtn.addEventListener('click', () => {
            userForm.reset();
            resetFormState();
        });

        // Restablecer el estado del formulario a "agregar nuevo"
        function resetFormState() {
            editingDocId = null;
            formTitle.textContent = "Agregar Nuevo Usuario";
            saveUserBtn.textContent = "Guardar Usuario";
            cancelEditBtn.classList.add('hidden');
        }

        // Manejador para el botón de eliminar
        async function handleDeleteUser(e) {
            const userId = e.currentTarget.dataset.id;
            if (confirm("¿Estás seguro de que deseas eliminar a este usuario?")) {
                try {
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
                    await deleteDoc(userRef);
                    showMessage("Usuario eliminado con éxito.", "authorized");
                } catch (e) {
                    console.error("Error al eliminar el usuario:", e);
                    showMessage("Error al eliminar el usuario.", "unauthorized");
                }
            }
        }

        // Función para generar y mostrar los códigos QR
        function generateQRCodes() {
            qrList.innerHTML = '';
            authorizedUsers.forEach(user => {
                const card = document.createElement('div');
                card.className = 'w-[320px] bg-gray-50 p-6 rounded-xl shadow-lg flex flex-col items-center text-center printable-card';
                card.id = `card-${user.name.replace(/\s/g, '-')}`;

                const userPhoto = document.createElement('img');
                userPhoto.className = 'w-32 h-32 rounded-lg object-cover ring-2 ring-gray-300';
                userPhoto.src = user.photoUrl || 'https://placehold.co/128x128/CCCCCC/000000?text=User'; 
                userPhoto.alt = `Foto de perfil de ${user.name}`;
                userPhoto.onerror = () => { userPhoto.src = `https://placehold.co/128x128/CCCCCC/000000?text=${user.name.split(' ').map(n => n[0]).join('')}`; };
                card.appendChild(userPhoto);
                
                const name = document.createElement('p');
                name.className = 'text-2xl font-bold text-gray-700 mt-4';
                name.textContent = user.name;
                card.appendChild(name);

                const qrCanvas = document.createElement('canvas');
                qrCanvas.id = `qr-canvas-${user.name.replace(/\s/g, '-')}`;
                qrCanvas.className = 'w-32 h-32 mt-4';
                card.appendChild(qrCanvas);

                QRCode.toCanvas(qrCanvas, user.name, { errorCorrectionLevel: 'H', scale: 8 }, function (error) {
                    if (error) console.error(error);
                });

                qrList.appendChild(card);
            });
        }

        // Función para guardar el registro del escaneo en Firestore
        async function saveScanRecord(userName, scanType) {
            if (!db) {
                console.error("Base de datos no inicializada. No se pudo guardar el registro.");
                return;
            }
            try {
                // Obtener la colección 'scans'
                const scansCol = collection(db, 'artifacts', appId, 'public', 'data', 'scans');
                
                // Crear el nuevo documento con los datos del escaneo
                await addDoc(scansCol, {
                    userName: userName,
                    type: scanType,
                    timestamp: new Date()
                });
                console.log("Registro de escaneo guardado con éxito.");
            } catch (e) {
                console.error("Error al agregar el documento: ", e);
            }
        }

        // Cargar y mostrar el historial de escaneos desde Firestore
        async function loadScanHistory() {
            if (!db) {
                historyMessage.textContent = "Base de datos no disponible.";
                historyMessage.classList.remove('hidden');
                return;
            }
            
            historyMessage.textContent = "Cargando historial...";
            historyMessage.classList.remove('hidden');
            historyList.innerHTML = '';

            try {
                const scansCol = collection(db, 'artifacts', appId, 'public', 'data', 'scans');
                const querySnapshot = await getDocs(scansCol);
                const records = [];

                querySnapshot.forEach((doc) => {
                    records.push(doc.data());
                });

                // Ordenar los registros por fecha (del más reciente al más antiguo)
                records.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

                historyMessage.classList.add('hidden');

                if (records.length === 0) {
                    historyList.innerHTML = `
                        <tr class="bg-white border-b">
                            <td colspan="3" class="text-center py-4 text-gray-400">No hay registros de escaneo aún.</td>
                        </tr>
                    `;
                    return;
                }

                records.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    
                    const time = record.timestamp.toDate();
                    const formattedDate = time.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                    const formattedTime = time.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                    row.innerHTML = `
                        <td class="py-4 px-6 font-medium text-gray-900 whitespace-nowrap">
                            ${record.userName}
                        </td>
                        <td class="py-4 px-6">
                            <span class="px-2 py-1 font-semibold leading-tight rounded-full ${record.type === 'ingreso' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${record.type}
                            </span>
                        </td>
                        <td class="py-4 px-6 text-gray-600">
                            ${formattedDate} ${formattedTime}
                        </td>
                    `;
                    historyList.appendChild(row);
                });

            } catch (e) {
                console.error("Error al cargar el historial: ", e);
                historyMessage.textContent = "Error al cargar el historial. Inténtalo de nuevo más tarde.";
                historyMessage.classList.remove('hidden');
            }
        }


        // Callback cuando se escanea un código QR con éxito
        const onScanSuccess = (decodedText, decodedResult) => {
            console.log(`Código escaneado: ${decodedText}`);
            html5QrCode.stop().then(() => {
                isScannerRunning = false;
            }).catch(err => {});

            const user = authorizedUsers.find(u => u.name === decodedText);

            if (user) {
                const today = new Date();
                const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const fromDate = new Date(user.authorizedFrom);
                const untilDate = new Date(user.authorizedUntil);

                if (todayMidnight >= fromDate && todayMidnight <= untilDate) {
                    const datesMessage = `Válido desde ${user.authorizedFrom} hasta ${user.authorizedUntil}.`;
                    showResultPage(user.name, true, datesMessage, user.photoUrl);
                    // Llama a la función para guardar el registro de ingreso/salida
                    saveScanRecord(user.name, scanMode);
                } else {
                    showResultPage(user.name, false, "El acceso no está autorizado en esta fecha.", user.photoUrl);
                }
            } else {
                showResultPage(decodedText, false, "Usuario no autorizado.", null);
            }
        };

        // Función para iniciar el escáner
        function startScanner() {
            startScannerButton.textContent = "Iniciando...";
            startScannerButton.disabled = true;
            readerDiv.classList.remove('hidden');
            scannerInstruction.textContent = "Apunta la cámara a un código QR para validar el acceso.";

            html5QrCode.start({ facingMode: "environment" }, qrCodeScannerConfig, onScanSuccess)
                .then(() => {
                    isScannerRunning = true;
                    startScannerButton.classList.add('hidden');
                })
                .catch(err => {
                    console.error("Error al iniciar el escáner: ", err);
                    startScannerButton.textContent = "Reintentar Habilitar Cámara";
                    startScannerButton.disabled = false;
                    readerDiv.classList.add('hidden');
                    scannerInstruction.textContent = "Acceso a la cámara denegado. Por favor, revisa la configuración de tu navegador.";
                });
        }
        
        // Función para cambiar de pestaña y manejar el escáner
        function changeTab(targetTab) {
            qrGeneratorSection.classList.add('hidden');
            qrScannerSection.classList.add('hidden');
            resultPageSection.classList.add('hidden');
            historySection.classList.add('hidden');
            adminSection.classList.add('hidden');

            mainContainer.classList.remove('bg-authorized', 'bg-unauthorized');
            mainContainer.classList.add('bg-white');
            tabNavigation.classList.remove('hidden');
            
            if (isScannerRunning) {
                html5QrCode.stop().then(() => {
                    isScannerRunning = false;
                }).catch(err => {});
            }

            tabGenerator.classList.remove('border-indigo-500', 'text-indigo-600');
            tabScanner.classList.remove('border-indigo-500', 'text-indigo-600');
            tabHistory.classList.remove('border-indigo-500', 'text-indigo-600');
            tabAdmin.classList.remove('border-indigo-500', 'text-indigo-600');

            if (targetTab === 'generator') {
                qrGeneratorSection.classList.remove('hidden');
                tabGenerator.classList.add('border-indigo-500', 'text-indigo-600');
                generateQRCodes();
            } else if (targetTab === 'scanner') {
                qrScannerSection.classList.remove('hidden');
                tabScanner.classList.add('border-indigo-500', 'text-indigo-600');
                
                startScannerButton.classList.remove('hidden');
                startScannerButton.textContent = "Habilitar Cámara";
                startScannerButton.disabled = false;
                readerDiv.classList.add('hidden');
                scannerInstruction.textContent = "Presiona 'Habilitar Cámara' para comenzar a escanear.";
            } else if (targetTab === 'history') {
                historySection.classList.remove('hidden');
                tabHistory.classList.add('border-indigo-500', 'text-indigo-600');
                loadScanHistory();
            } else if (targetTab === 'admin') {
                adminSection.classList.remove('hidden');
                tabAdmin.classList.add('border-indigo-500', 'text-indigo-600');
                renderUserList();
            }
        }

        // Función para el inicio de sesión del generador
        function handleAdminLogin() {
            const username = prompt("Ingresa el usuario:");
            const password = prompt("Ingresa la contraseña:");

            const correctUsername = "admin";
            const correctPassword = "admin123";

            if (username === correctUsername && password === correctPassword) {
                tabAdmin.classList.remove('hidden');
                changeTab('admin');
            } else {
                showMessage("Usuario o contraseña incorrectos.", "unauthorized");
                changeTab('scanner');
            }
        }

        // Función para imprimir las tarjetas
        function printCards() {
            window.print();
        }

        // Función para guardar las tarjetas COMPLETAS como imágenes
        async function saveCardsAsImages() {
            const cards = document.querySelectorAll('.printable-card');
            
            for (const card of cards) {
                const canvas = await html2canvas(card, {
                    scale: 2,
                    logging: false
                });

                const dataURL = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataURL;
                const userName = card.id.replace('card-', '');
                link.download = `${userName}-credencial.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        // Manejadores de eventos para los botones de modo de escaneo
        modeIngresoBtn.addEventListener('click', () => {
            scanMode = 'ingreso';
            modeIngresoBtn.classList.remove('bg-gray-300', 'text-gray-800', 'hover:bg-gray-400');
            modeIngresoBtn.classList.add('bg-indigo-500', 'text-white');
            modeSalidaBtn.classList.remove('bg-indigo-500', 'text-white');
            modeSalidaBtn.classList.add('bg-gray-300', 'text-gray-800', 'hover:bg-gray-400');
            showMessage("Modo de escaneo cambiado a: INGRESO", "info");
        });

        modeSalidaBtn.addEventListener('click', () => {
            scanMode = 'salida';
            modeSalidaBtn.classList.remove('bg-gray-300', 'text-gray-800', 'hover:bg-gray-400');
            modeSalidaBtn.classList.add('bg-indigo-500', 'text-white');
            modeIngresoBtn.classList.remove('bg-indigo-500', 'text-white');
            modeIngresoBtn.classList.add('bg-gray-300', 'text-gray-800', 'hover:bg-gray-400');
            showMessage("Modo de escaneo cambiado a: SALIDA", "info");
        });

        // Manejadores de eventos actualizados
        tabGenerator.addEventListener('click', () => changeTab('generator'));
        tabScanner.addEventListener('click', () => changeTab('scanner'));
        tabHistory.addEventListener('click', () => changeTab('history'));
        tabAdmin.addEventListener('click', handleAdminLogin);
        startScannerButton.addEventListener('click', startScanner);
        backToScannerButton.addEventListener('click', () => changeTab('scanner'));
        printButton.addEventListener('click', printCards);
        saveButton.addEventListener('click', saveCardsAsImages);

        // Iniciar la aplicación en la pestaña del escáner por defecto
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase(); // Inicializa Firebase al cargar la página
            changeTab('scanner');
        });
    </script>
</body>
</html>
