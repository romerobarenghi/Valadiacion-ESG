<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador de Código QR</title>
    <!-- Tailwind CSS CDN para estilos responsivos y modernos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librería para convertir elementos HTML en imágenes -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- CORREGIDO: Usar <link> para la fuente en lugar de @import en <style> -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Estilos para el mensaje emergente, si es necesario */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1.5rem 2rem;
            border-radius: 0.75rem;
            color: white;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 100;
            display: none;
            transition: all 0.5s ease-in-out;
            max-width: 90%;
            width: fit-content;
        }
        .message-box.authorized {
            background-color: #10b981; /* Verde esmeralda */
        }
        .message-box.unauthorized {
            background-color: #ef4444; /* Rojo */
        }

        /* Clases de colores de fondo dinámicos */
        .bg-authorized {
            background-color: #d1fae5; /* Verde claro */
        }
        .bg-unauthorized {
            background-color: #fee2e2; /* Rojo claro */
        }
        .text-authorized {
            color: #065f46; /* Verde oscuro */
        }
        .text-unauthorized {
            color: #991b1b; /* Rojo oscuro */
        }

        /* Estilos específicos para la impresión */
        @media print {
            body {
                background-color: white !important; /* Fondo blanco para ahorrar tinta */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            /* Ocultar elementos no necesarios para la impresión */
            .no-print {
                display: none !important;
            }
            /* Mostrar las tarjetas en una grilla para optimizar el espacio en la hoja */
            #qr-list {
                display: flex; /* Cambiamos a flex para una grilla */
                flex-wrap: wrap;
                justify-content: center;
                /* Asegura que el contenido se ajuste correctamente */
                padding: 1.5rem;
                gap: 1.5rem;
            }
            /* Ajustar el tamaño de la tarjeta para impresión, quitando la sombra y el padding extra */
            .printable-card {
                width: 320px; /* Ancho fijo para impresión */
                height: 208px; /* Alto fijo para impresión */
                box-shadow: none; /* Eliminar sombras para impresión */
                border: 1px solid #ccc; /* Añadir un borde sutil */
                padding: 1rem;
                /* SOLUCIÓN MEJORADA: Evita que el elemento se corte al final de una página */
                page-break-inside: avoid;
                margin-bottom: 1.5rem; /* Asegura un espacio adecuado entre tarjetas */
            }
            .printable-card canvas {
                /* Asegurar que el canvas del QR también se ajuste */
                width: 96px;
                height: 96px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <!-- Contenedor principal de la aplicación -->
    <div id="main-container" class="max-w-4xl w-full bg-white rounded-xl shadow-2xl p-6 md:p-10 space-y-8 transition-colors duration-500">

        <!-- Título de la aplicación -->
        <h1 class="text-4xl md:text-5xl font-bold text-center text-gray-800 no-print">
            Validador de Acceso
        </h1>

        <!-- Pestañas de navegación -->
        <div id="tab-navigation" class="flex justify-center border-b border-gray-200 no-print">
            <button id="tab-generator" class="py-3 px-6 text-lg font-medium text-gray-600 hover:text-indigo-600 border-b-2 border-transparent hover:border-indigo-500 focus:outline-none transition-colors duration-200">
                Generador de Códigos
            </button>
            <button id="tab-scanner" class="py-3 px-6 text-lg font-medium text-gray-600 hover:text-indigo-600 border-b-2 border-transparent hover:border-indigo-500 focus:outline-none transition-colors duration-200">
                Escáner de QR
            </button>
        </div>

        <!-- Sección de generación de códigos QR -->
        <div id="qr-generator-section" class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700 text-center no-print">Tarjetas de Acceso Autorizado</h2>
            <!-- Botones de impresión y guardar como imagen -->
            <div class="flex justify-center gap-4 no-print">
                <button id="print-button" class="bg-indigo-600 text-white px-6 py-3 rounded-md font-semibold text-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                    Imprimir Tarjetas
                </button>
                <button id="save-button" class="bg-green-600 text-white px-6 py-3 rounded-md font-semibold text-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200">
                    Guardar como Imagen
                </button>
            </div>
            
            <!-- CAMBIO PRINCIPAL: Se usa un layout de grid para mostrar las tarjetas -->
            <div id="qr-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 justify-items-center">
                <!-- Los códigos QR se renderizarán aquí -->
            </div>
        </div>

        <!-- Sección del escáner de QR -->
        <div id="qr-scanner-section" class="hidden flex flex-col items-center space-y-6 no-print">
            <h2 class="text-2xl font-semibold text-gray-700 text-center">Escanear para Validar</h2>
            <button id="start-scanner-button" class="bg-indigo-600 text-white px-6 py-3 rounded-md font-semibold text-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                Habilitar Cámara
            </button>
            <div id="reader" class="w-full max-w-sm rounded-lg overflow-hidden border-4 border-indigo-500 shadow-xl mt-4 hidden"></div>
            <p id="scanner-instruction" class="text-lg text-gray-500 text-center mt-4">
                Presiona "Habilitar Cámara" para comenzar a escanear.
            </p>
        </div>

        <!-- SECCIÓN: Página de validación de acceso -->
        <div id="result-page-section" class="hidden flex flex-col items-center space-y-6 text-center">
            <!-- Espacio para la foto del usuario -->
            <img id="result-photo" class="w-32 h-32 rounded-lg ring-4 ring-gray-300 object-cover mb-4 hidden" src="" alt="Foto del usuario">
            <h2 id="result-title" class="text-4xl font-bold"></h2>
            <p id="result-user-info" class="text-2xl font-semibold"></p>
            <div id="result-dates" class="text-lg text-gray-600"></div> <!-- NUEVO ELEMENTO PARA LAS FECHAS -->
            <div id="result-badge" class="font-bold py-3 px-6 rounded-full shadow-lg">
                <span id="result-text" class="text-xl"></span>
            </div>
            <button id="back-to-scanner-button" class="bg-gray-500 text-white px-6 py-3 rounded-md font-semibold text-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors duration-200 mt-8">
                Volver a Escanear
            </button>
        </div>
    </div>

    <!-- Scripts CDN para las librerías -->
    <!-- Librería para generar códigos QR -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <!-- Librería para escanear códigos QR con la cámara -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script>
        // Variable para almacenar la lista de usuarios. Inicialmente vacía.
        let authorizedUsers = [];

        // Elementos del DOM
        const mainContainer = document.getElementById('main-container');
        const qrList = document.getElementById('qr-list');
        const qrGeneratorSection = document.getElementById('qr-generator-section');
        const qrScannerSection = document.getElementById('qr-scanner-section');
        const resultPageSection = document.getElementById('result-page-section');
        const resultPhoto = document.getElementById('result-photo');
        const resultTitle = document.getElementById('result-title');
        const resultUserInfo = document.getElementById('result-user-info');
        const resultDates = document.getElementById('result-dates');
        const resultBadge = document.getElementById('result-badge');
        const resultText = document.getElementById('result-text');
        const backToScannerButton = document.getElementById('back-to-scanner-button');
        const tabGenerator = document.getElementById('tab-generator');
        const tabScanner = document.getElementById('tab-scanner');
        const tabNavigation = document.getElementById('tab-navigation');
        const startScannerButton = document.getElementById('start-scanner-button');
        const scannerInstruction = document.getElementById('scanner-instruction');
        const readerDiv = document.getElementById('reader');
        const printButton = document.getElementById('print-button');
        const saveButton = document.getElementById('save-button');

        // Variable para rastrear el estado del escáner
        let isScannerRunning = false;

        // Configuración del escáner de QR
        const html5QrCode = new Html5Qrcode("reader");
        const qrCodeScannerConfig = { fps: 10, qrbox: { width: 250, height: 250 } };

        // Función para cargar los datos del archivo JSON
        // Se ha añadido un parámetro para evitar el caché del navegador.
        async function loadUserData() {
            try {
                // Obtener el timestamp actual para crear un parámetro único en la URL
                const now = new Date().getTime();
                const url = `users.json?v=${now}`;
                
                // Realizar la solicitud HTTP para obtener el archivo users.json
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                authorizedUsers = await response.json();
                console.log("Datos de usuarios cargados:", authorizedUsers);

                // Una vez que los datos están cargados, generar los códigos QR
                generateQRCodes();

            } catch (error) {
                console.error("Error al cargar los datos de los usuarios:", error);
                // Si el archivo no se puede cargar, mostrar un mensaje de error y no continuar
                qrGeneratorSection.innerHTML = '<p class="text-center text-red-500 font-semibold text-lg p-4">Error al cargar los datos del personal. Asegúrate de que el archivo `users.json` exista y sea válido en tu repositorio de GitHub.</p>';
            }
        }

        // Función para mostrar la página de resultados
        function showResultPage(userName, isAuthorized, message = null, photoUrl = null) {
            // Ocultar todas las secciones y pestañas de navegación
            qrScannerSection.classList.add('hidden');
            tabNavigation.classList.add('hidden');

            // Mostrar la sección de resultados
            resultPageSection.classList.remove('hidden');

            // Limpiar clases de color y aplicar las nuevas
            mainContainer.classList.remove('bg-white', 'bg-authorized', 'bg-unauthorized');
            resultTitle.classList.remove('text-authorized', 'text-unauthorized');
            resultUserInfo.classList.remove('text-authorized', 'text-unauthorized');
            resultBadge.classList.remove('bg-green-500', 'bg-red-500');

            // Actualizar la foto del usuario
            if (photoUrl) {
                resultPhoto.src = photoUrl;
                resultPhoto.classList.remove('hidden');
            } else {
                resultPhoto.classList.add('hidden');
            }

            if (isAuthorized) {
                mainContainer.classList.add('bg-authorized');
                resultTitle.classList.add('text-authorized');
                resultUserInfo.classList.add('text-authorized');
                resultBadge.classList.add('bg-green-500', 'text-white');
                resultTitle.textContent = "Acceso Autorizado";
                resultUserInfo.textContent = userName;
                resultDates.textContent = message; // Aquí se muestra el rango de fechas
                resultText.textContent = "Autorizado";
            } else {
                mainContainer.classList.add('bg-unauthorized');
                resultTitle.classList.add('text-unauthorized');
                resultUserInfo.classList.add('text-unauthorized');
                resultBadge.classList.add('bg-red-500', 'text-white');
                resultTitle.textContent = "Acceso Denegado";
                resultUserInfo.textContent = userName;
                resultDates.textContent = message; // Aquí se muestra el motivo del rechazo
                resultText.textContent = "No Autorizado";
            }
        }

        // Función para generar y mostrar los códigos QR
        function generateQRCodes() {
            qrList.innerHTML = ''; // Limpiar la lista existente
            authorizedUsers.forEach(user => {
                const card = document.createElement('div');
                // Se ajustan las clases para el formato horizontal de tarjeta de crédito
                card.className = 'w-[320px] h-[208px] bg-gray-50 p-4 rounded-xl shadow-lg flex flex-col justify-between printable-card';
                // Agregar un ID para identificar el usuario
                card.id = `card-${user.name.replace(/\s/g, '-')}`;

                // Contenedor para el título, la foto y el nombre
                const topContent = document.createElement('div');
                topContent.className = 'flex flex-row items-center justify-between';

                // Título de la tarjeta
                const cardTitle = document.createElement('p');
                cardTitle.className = 'text-xs font-semibold text-gray-400';
                cardTitle.textContent = 'ID de Acceso';
                topContent.appendChild(cardTitle);

                // Agregar la imagen de perfil a la tarjeta
                const userPhoto = document.createElement('img');
                // Reducimos el tamaño de la imagen a 96x96px para que encaje en el nuevo diseño
                userPhoto.className = 'w-24 h-24 rounded-lg object-cover ring-2 ring-gray-300';
                // Usar la URL de la foto del JSON
                userPhoto.src = user.photoUrl; 
                userPhoto.alt = `Foto de perfil de ${user.name}`;
                // Fallback en caso de que la imagen no cargue, ahora con el nuevo tamaño
                userPhoto.onerror = () => { userPhoto.src = `https://placehold.co/96x96/CCCCCC/000000?text=${user.name.split(' ').map(n => n[0]).join('')}`; };
                topContent.appendChild(userPhoto);

                card.appendChild(topContent);

                // Contenedor para el nombre y el QR
                const bottomContent = document.createElement('div');
                bottomContent.className = 'flex flex-row items-center justify-between mt-2';
                
                const name = document.createElement('p');
                name.className = 'text-lg font-bold text-gray-700';
                name.textContent = user.name;
                bottomContent.appendChild(name);

                const qrCanvas = document.createElement('canvas');
                // Agregar un ID para el canvas y usar un nombre de archivo
                qrCanvas.id = `qr-canvas-${user.name.replace(/\s/g, '-')}`;
                // El tamaño del QR es de 96x96px para que encaje en el nuevo diseño
                qrCanvas.className = 'w-24 h-24';
                bottomContent.appendChild(qrCanvas);
                
                card.appendChild(bottomContent);

                // Generar el código QR con el nombre de la persona
                QRCode.toCanvas(qrCanvas, user.name, { errorCorrectionLevel: 'H', scale: 8 }, function (error) {
                    if (error) console.error(error);
                });

                qrList.appendChild(card);
            });
        }

        // Callback cuando se escanea un código QR con éxito
        const onScanSuccess = (decodedText, decodedResult) => {
            console.log(`Código escaneado: ${decodedText}`);
            html5QrCode.stop().then(() => {
                isScannerRunning = false;
            }).catch(err => {});

            // Buscar al usuario escaneado en la lista de autorizados
            const user = authorizedUsers.find(u => u.name === decodedText);

            if (user) {
                const today = new Date();
                const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const fromDate = new Date(user.authorizedFrom);
                const untilDate = new Date(user.authorizedUntil);

                console.log("Fecha actual (medianoche):", todayMidnight);
                console.log("Fecha de inicio:", fromDate);
                console.log("Fecha de fin:", untilDate);

                if (todayMidnight >= fromDate && todayMidnight <= untilDate) {
                    // La fecha es válida
                    const datesMessage = `Válido desde ${user.authorizedFrom} hasta ${user.authorizedUntil}.`;
                    showResultPage(user.name, true, datesMessage, user.photoUrl);
                } else {
                    // La fecha no es válida
                    showResultPage(user.name, false, "El acceso no está autorizado en esta fecha.", user.photoUrl);
                }

            } else {
                // Usuario no encontrado
                showResultPage(decodedText, false, "Usuario no autorizado.", null);
            }
        };

        // Función para iniciar el escáner
        function startScanner() {
            startScannerButton.textContent = "Iniciando...";
            startScannerButton.disabled = true;
            readerDiv.classList.remove('hidden');
            scannerInstruction.textContent = "Apunta la cámara a un código QR para validar el acceso.";

            html5QrCode.start({ facingMode: "environment" }, qrCodeScannerConfig, onScanSuccess)
                .then(() => {
                    isScannerRunning = true;
                    startScannerButton.classList.add('hidden');
                })
                .catch(err => {
                    console.error("Error al iniciar el escáner: ", err);
                    startScannerButton.textContent = "Reintentar Habilitar Cámara";
                    startScannerButton.disabled = false;
                    readerDiv.classList.add('hidden');
                    scannerInstruction.textContent = "Acceso a la cámara denegado. Por favor, revisa la configuración de tu navegador.";
                });
        }
        
        // Función para cambiar de pestaña y manejar el escáner
        function changeTab(targetTab) {
            // Ocultar todas las secciones
            qrGeneratorSection.classList.add('hidden');
            qrScannerSection.classList.add('hidden');
            resultPageSection.classList.add('hidden');

            // Volver al fondo blanco y mostrar la navegación
            mainContainer.classList.remove('bg-authorized', 'bg-unauthorized');
            mainContainer.classList.add('bg-white');
            tabNavigation.classList.remove('hidden');
            
            // Detener el escáner si está corriendo
            if (isScannerRunning) {
                html5QrCode.stop().then(() => {
                    isScannerRunning = false;
                }).catch(err => {});
            }

            // Ocultar las clases de pestañas
            tabGenerator.classList.remove('border-indigo-500', 'text-indigo-600');
            tabScanner.classList.remove('border-indigo-500', 'text-indigo-600');

            // Mostrar la sección y activar la pestaña correspondiente
            if (targetTab === 'generator') {
                qrGeneratorSection.classList.remove('hidden');
                tabGenerator.classList.add('border-indigo-500', 'text-indigo-600');
                generateQRCodes();
            } else if (targetTab === 'scanner') {
                qrScannerSection.classList.remove('hidden');
                tabScanner.classList.add('border-indigo-500', 'text-indigo-600');
                
                // Reiniciar el estado del botón y la instrucción
                startScannerButton.classList.remove('hidden');
                startScannerButton.textContent = "Habilitar Cámara";
                startScannerButton.disabled = false;
                readerDiv.classList.add('hidden');
                scannerInstruction.textContent = "Presiona 'Habilitar Cámara' para comenzar a escanear.";
            }
        }

        // Función para imprimir las tarjetas
        function printCards() {
            window.print();
        }

        // NUEVO: Función para guardar las tarjetas COMPLETAS como imágenes
        async function saveCardsAsImages() {
            // Obtener todos los elementos de la tarjeta
            const cards = document.querySelectorAll('.printable-card');
            
            for (const card of cards) {
                // Usar html2canvas para renderizar cada tarjeta a un canvas
                const canvas = await html2canvas(card, {
                    scale: 2, // Aumenta la escala para una mejor calidad de imagen
                    logging: false // Desactiva los mensajes de la consola
                });

                // Obtener la URL de la imagen del canvas
                const dataURL = canvas.toDataURL('image/png');
                
                // Crear un enlace temporal para la descarga
                const link = document.createElement('a');
                link.href = dataURL;
                
                // Obtener el nombre del usuario de la tarjeta para el nombre del archivo
                const userName = card.id.replace('card-', '');
                link.download = `${userName}-credencial.png`;
                
                // Simular el clic en el enlace para iniciar la descarga
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Manejadores de eventos para los botones de las pestañas
        tabGenerator.addEventListener('click', () => changeTab('generator'));
        tabScanner.addEventListener('click', () => changeTab('scanner'));
        startScannerButton.addEventListener('click', startScanner);
        backToScannerButton.addEventListener('click', () => changeTab('scanner'));
        printButton.addEventListener('click', printCards);
        // El botón de guardar ahora llama a la nueva función
        saveButton.addEventListener('click', saveCardsAsImages);

        // Iniciar la aplicación y cargar los datos
        document.addEventListener('DOMContentLoaded', () => {
            loadUserData(); // Inicia el proceso de carga de datos
            changeTab('generator');
        });
    </script>
</body>
</html>
